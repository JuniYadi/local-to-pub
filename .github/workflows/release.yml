name: Release

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: "Version bump type"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
      prerelease:
        description: "Pre-release identifier (e.g., alpha, beta, rc)"
        required: false
        type: string
        default: ""

permissions:
  contents: write

jobs:
  version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.bump.outputs.new_version }}
      previous_version: ${{ steps.bump.outputs.previous_version }}
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Bump version
        id: bump
        run: |
          CURRENT=$(node -p "require('./package.json').version")
          echo "Previous version: $CURRENT" >> $GITHUB_STEP_SUMMARY

          PRERELEASE="${{ github.event.inputs.prerelease }}"
          TYPE="${{ github.event.inputs.version_type }}"

          if [ -n "$PRERELEASE" ]; then
            NEW_VERSION=$(npm version --no-git-tag-version $TYPE --preid=$PRERELEASE)
          else
            NEW_VERSION=$(npm version --no-git-tag-version $TYPE)
          fi

          # Remove 'v' prefix that npm adds
          NEW_VERSION=${NEW_VERSION#v}

          echo "New version: $NEW_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "previous_version=$CURRENT" >> $GITHUB_OUTPUT
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Commit version bump and create tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json
          git commit -m "chore: bump version to ${{ steps.bump.outputs.new_version }}"
          git push
          git tag -a v${{ steps.bump.outputs.new_version }} -m "Release v${{ steps.bump.outputs.new_version }}"
          git push origin v${{ steps.bump.outputs.new_version }}

  build:
    needs: version
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux amd64 - Client
          - os: ubuntu-latest
            platform: linux
            arch: amd64
            target: bun-linux-x64
            binary: client
          # Linux amd64 - Server
          - os: ubuntu-latest
            platform: linux
            arch: amd64
            target: bun-linux-x64
            binary: server
          # Linux arm64 - Client
          - os: ubuntu-latest
            platform: linux
            arch: arm64
            target: bun-linux-arm64
            binary: client
          # Linux arm64 - Server
          - os: ubuntu-latest
            platform: linux
            arch: arm64
            target: bun-linux-arm64
            binary: server
          # macOS amd64 (Intel) - Client
          - os: macos-latest
            platform: darwin
            arch: amd64
            target: bun-darwin-x64
            binary: client
          # macOS arm64 (Apple Silicon) - Client
          - os: macos-14
            platform: darwin
            arch: arm64
            target: bun-darwin-arm64
            binary: client

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build server
        if: matrix.binary == 'server'
        run: |
          bun run scripts/embed-frontend.ts
          bun build ./packages/server/index.ts \
            --compile \
            --target=${{ matrix.target }} \
            --outfile=local-to-pub-server

      - name: Build client
        if: matrix.binary == 'client'
        run: |
          bun build ./packages/client/index.ts \
            --compile \
            --target=${{ matrix.target }} \
            --outfile=local-to-pub-client

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.binary }}-${{ matrix.platform }}-${{ matrix.arch }}
          path: |
            local-to-pub-${{ matrix.binary }}
          retention-days: 7

  release:
    needs: [version, build]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Package releases
        run: |
          cd artifacts
          for dir in */; do
            BINARY_DIR=$(basename "$dir")
            tar -czf "../local-to-pub-${BINARY_DIR}-${{ needs.version.outputs.version }}.tar.gz" -C "$dir" .
          done

      - name: Calculate checksums
        id: checksums
        run: |
          echo "## ðŸ“¦ Checksums" > release-body.md
          echo "" >> release-body.md
          echo "Verify the integrity of downloaded files:" >> release-body.md
          echo "" >> release-body.md
          echo '```' >> release-body.md
          find . -name "*.tar.gz" -exec shasum -a 256 {} \; | sort >> release-body.md
          echo '```' >> release-body.md
          echo "" >> release-body.md
          echo "To verify a downloaded file, run:" >> release-body.md
          echo "" >> release-body.md
          echo '```bash' >> release-body.md
          echo "shasum -a 256 <downloaded-file> | grep -q \$(cat checksums.txt | grep <downloaded-file> | awk '{print \$1}')" >> release-body.md
          echo '```' >> release-body.md

          # Also create standalone checksums.txt file
          find . -name "*.tar.gz" -exec shasum -a 256 {} \; | sort > checksums.txt

          # Output the body for next step
          echo "body<<EOF" >> $GITHUB_OUTPUT
          cat release-body.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: v${{ needs.version.outputs.version }}
          tag_name: v${{ needs.version.outputs.version }}
          body: ${{ steps.checksums.outputs.body }}
          draft: false
          prerelease: false
          files: |
            *.tar.gz
            checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
